<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="md5.js"></script>
<script type="text/javascript" src="jcap.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="jquery.cookie.js"></script>
<script type="text/javascript" src="jquery.csv2table.js"></script>
</head>
<body>
<script type="text/javascript">
$(function(){
    var cookie_target_id = "#send_to_raw,#from_name,#from,#title,#body";
    var get_cookie_key = function(id) {
        return "s_m_" + id;
    };
    var get_cookie = function(id) {
        return $.cookie(get_cookie_key(id));
    };
    var set_cookie = function(id, value) {
        var expire_day = 1000;
        $.cookie(get_cookie_key(id), value, expire_day);
    };
    var save_input = function() {
        $(cookie_target_id).each(function(){
            set_cookie($(this).attr('id'), $(this).val());
        });
    };
    var check_input_test_send = function() {
        var required = "#from";
        var result = true;
        $(required).each(function(){
            if (!$(this).val()) {
                var id = $(this).attr('id');
                var label = $("label[for='"+id+"']").text();
                window.alert(label+"を入力してください");
                result = false;
                return;
            }
        });
        return result;
    };

    var check_input_send = function() {
        var required = "#from";
        var result = true;
        $(required).each(function(){
            if (!$(this).val()) {
                var id = $(this).attr('id');
                var label = $("label[for='"+id+"']").text();
                window.alert(label+"を入力してください");
                result = false;
                return;
            }
        });
        var address_result = true;
        var address = $("input[name='send_to_address[]']");
        if (address.length < 1) {
            window.alert("送信先を正しく入力してください");
            address_result = false;
        } else {
            address.each(function(){
                if (address_result && !$(this).val()) {
                    window.alert("送信先を正しく入力してください");
                    address_result = false;
                    return;
                }
            });
        }
        return (result && address_result);
    };

    var load_send_to = function() {
        var tbody_html = "";
        var raw = $("#send_to_raw").val();
        var rows = raw.split(/[\n\f\r]/);
        rows.forEach(function (row) {
            row = row.trim();
            if (row == '') {
                return;
            }
            var cols = row.split(/[,\t]/);
            var name = cols[0] || "";
            var address = cols[1] || "";
            tbody_html = tbody_html + 
                '<tr>' + 
                '<td>' + name + '<input type="hidden" name="send_to_name[]" value="' + name + '" /></td>' + 
                '<td>' + address + '<input type="hidden" name="send_to_address[]" value="' + address + '" /></td>' +
                '</tr>';
        });
        $("#send_to tbody").html(tbody_html);
    };

    // 送信先
    $("#send_to_raw").bind('input propertychange', function() {
        load_send_to();
    });

    // set default value
    $(cookie_target_id).each(function(){
        var value = get_cookie($(this).attr('id'));
        if (value) {
            $(this).val(value);
        }
    });

    // ファイルリセット
    $("input[name='file_reset']").each(function(){
        var id_for = $(this).attr('for');
        var clone = $("#"+id_for).clone();
        $(this).click(function(){
            clone.val('');
            $("#"+id_for).replaceWith(clone);
        });
    });

    $('#test_send').click(function(){
        save_input();
        if (!check_input_test_send()) {
            return false;
        }

        if (!confirm('テスト送信します。よろしいですか？')) {
            return false;
        }
        var fd = new FormData();
        fd.append("test_send", $("#test_send").val());
        fd.append("title", $("#title").val());
        fd.append("body", $("#body").val());
        fd.append("attachment", $("#attachment").prop("files")[0]);
        fd.append("from", $("#from").val());
        fd.append("from_name", $("#from_name").val());
        var post_data = {
            type : "POST",
            dataType : "text",
            data : fd,
            processData : false,
            contentType : false
        };
        $.ajax(
            "post.php", post_data
        ).done(function(text){
            // window.alert(text);
        });
        return false;
    });

    $('#submit').click(function(){
        save_input();
        if (!check_input_send()) {
            return false;
        }

        return (jcap() && confirm('送信します。よろしいですか？'));
    });

    load_send_to();
    $('#history').csv2table('history.php');
});
</script>
<style>
<!--
.table {
    border-collapse: collapse;
}
.table th {
    border: 1px solid black; 
}
.table td {
    border: 1px solid black; 
}
-->
</style>
<h2>送信フォーム</h2>
<form enctype="multipart/form-data" method="post" action="./post.php">

<!--
<h3>csvファイル</h3>
<table>
<tr>
  <td><label for="csv">csvファイル</label>:</td>
  <td><input type="file" name="csv" id="csv" /></td>
</tr>
<tr>
  <td><label for="csv_c">文字コード</label>:</td>
  <td>
    <select name="csv_c" id="csv_c">
      <option value="">自動で認識</option>
      <option value="SJIS">Shift-JIS</option>
      <option value="UTF-8">UTF-8</option>
      <option value="EUC-JP">EUC-JP</option>
    </select>
  </td>
</tr>
<tr>
  <td><input type="button" name="file_reset" for="csv" value="リセット" /></td>
</tr>
</table>
<p>※csvファイルは、メールアドレス,名前 の形式</p>
-->

<h3>送信先</h3>
<textarea id="send_to_raw" rows="5" cols="100"></textarea>
<table id="send_to" class="table">
<thead><tr><td>名前</td><td>メールアドレス</td></tr></thead>
<tbody></tbody>
</table>

<h3><label for="title">メールタイトル</label></h3>
<p>{name} が使用できます。</p>
<input type="text" name="title" id="title" size="100" />

<h3><label for="body">メール本文</label></h3>
<p>{name} が使用できます。</p>
<textarea name="body" id="body" rows="25" cols="100"></textarea>

<h3><label for="attachment">添付ファイル</label></h3>
<input type="file" name="attachment" id="attachment" /><br />
<input type="button" name="file_reset" for="attachment" value="リセット" />
</p>

<h3>送信元</h3>
<table>
<tr>
  <td><label for="from_name">送信者名</label>(省略可):</td>
  <td><input type="text" name="from_name" id="from_name" size="40" value="" /></td>
  <td></td></tr>
<tr>
  <td><label for="from">送信元メールアドレス</label>:</td>
  <td><input type="text" name="from" id="from" size="40" value="" /></td>
  <td><button type="submit" name="test_send" id="test_send" value="test_send">テスト送信</button></td>
</tr>
</table>

<h3>画像認証</h3>
<p>画像に表示された文字を入力してください。</p>
<script type="text/javascript">sjcap();</script>
<input type="submit" name="submit" id="submit" value="全員へ一斉送信する" />
</form>
<hr />

<h2>送信履歴 (直近1ヶ月)</h2>
<p id="history"></p>
</body>
</html>
